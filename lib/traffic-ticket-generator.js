/**
 * Traffic Ticket Defense Packet Generator
 * Generates comprehensive defense packets for traffic violations in TN, PA, NJ, MS
 *
 * UPL COMPLIANCE NOTICE: This tool provides information only, NOT legal advice.
 * Users should consult a licensed attorney for legal advice specific to their situation.
 */

const fs = require('fs');
const path = require('path');

// State configuration
const STATE_INFO = {
  tn: {
    name: 'Tennessee',
    code: 'TN',
    statutesPrefix: 'TCA',
    barAssociation: 'Tennessee Bar Association',
    barPhone: '(615) 742-6272',
    barWebsite: 'www.tba.org'
  },
  pa: {
    name: 'Pennsylvania',
    code: 'PA',
    statutesPrefix: '75 Pa.C.S.',
    barAssociation: 'Pennsylvania Bar Association',
    barPhone: '(800) 932-0311',
    barWebsite: 'www.pabar.org'
  },
  nj: {
    name: 'New Jersey',
    code: 'NJ',
    statutesPrefix: 'N.J.S.A.',
    barAssociation: 'New Jersey State Bar Association',
    barPhone: '(732) 249-5000',
    barWebsite: 'www.njsba.com'
  },
  ms: {
    name: 'Mississippi',
    code: 'MS',
    statutesPrefix: 'MS Code',
    barAssociation: 'Mississippi Bar',
    barPhone: '(601) 948-3149',
    barWebsite: 'www.msbar.org'
  }
};

/**
 * Get state-specific data paths
 */
function getStatePaths(state) {
  const basePath = path.join(__dirname, '../data/traffic-ticket', state);
  return {
    statutes: path.join(basePath, 'statutes.json'),
    procedures: path.join(basePath, 'procedures.json'),
    counties: path.join(basePath, 'counties')
  };
}

/**
 * UPL Compliance Disclaimers by state
 */
function getDisclaimers(state) {
  const stateInfo = STATE_INFO[state] || STATE_INFO.tn;

  return {
    header: `
IMPORTANT DISCLAIMER - NOT LEGAL ADVICE

This document is provided for INFORMATIONAL PURPOSES ONLY and does not constitute
legal advice. The information contained herein is general in nature and may not
apply to your specific situation.

You should consult with a licensed ${stateInfo.name} attorney for advice regarding your
individual case. The presentation of this information does not create an
attorney-client relationship.

Jurist Diction is not a law firm and cannot:
- Represent you in court
- Provide specific legal advice
- Guarantee any particular outcome
- File documents on your behalf

Information is believed to be current as of the date generated but laws change
frequently. Always verify information with current ${stateInfo.name} statutes and local
court rules.
`,
    footer: `
This packet was generated by Jurist Diction, a legal information service.
For attorney referrals, contact the ${stateInfo.barAssociation} Lawyer Referral Service
at ${stateInfo.barPhone} or visit ${stateInfo.barWebsite}

Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
Document ID: TD${stateInfo.code}-${Date.now()}
`
  };
}

/**
 * Main function to generate a traffic ticket defense packet
 * @param {object} ticketData - Ticket information (must include state)
 * @returns {object} Complete defense packet
 */
function generateTrafficTicketPacket(ticketData) {
  const state = normalizeState(ticketData.state || 'tn');
  const paths = getStatePaths(state);

  // Load required data
  const statutes = loadJsonFile(paths.statutes, getDefaultStatutes(state));
  const procedures = loadJsonFile(paths.procedures, getDefaultProcedures(state));
  const disclaimers = getDisclaimers(state);

  // Validate input
  const validatedData = validateTicketData({ ...ticketData, state });

  // Get county-specific information
  const countyData = getCountyData(validatedData.county, state);

  // Analyze the violation
  const analysis = analyzeViolation(validatedData, statutes, procedures, state);

  // Generate the packet
  const packet = {
    metadata: {
      generatedAt: new Date().toISOString(),
      documentId: `TD${STATE_INFO[state].code}-${Date.now()}`,
      version: '2.0',
      state: state.toUpperCase(),
      stateName: STATE_INFO[state].name,
      disclaimer: 'INFORMATIONAL ONLY - NOT LEGAL ADVICE'
    },
    disclaimers: disclaimers,
    ticket: validatedData,
    jurisdiction: {
      state: STATE_INFO[state],
      county: countyData,
      court: determineCourt(validatedData, countyData, state)
    },
    violation: {
      type: validatedData.violationType,
      statute: getStatuteInfo(validatedData.violationType, statutes),
      classification: classifyViolation(validatedData.violationType, statutes),
      points: calculatePoints(validatedData.violationType, statutes, validatedData, state),
      potentialPenalties: getPotentialPenalties(validatedData.violationType, statutes, state)
    },
    analysis: analysis,
    defenseStrategies: generateDefenseStrategies(validatedData, statutes, procedures),
    procedures: getApplicableProcedures(validatedData, procedures, state),
    timeline: generateTimeline(validatedData, countyData, state),
    documents: generateDocumentChecklist(validatedData, state),
    resources: generateResources(validatedData, countyData, state),
    stateSpecific: getStateSpecificInfo(state, validatedData),
    printableSections: generatePrintableSections(validatedData, statutes, procedures, countyData, state)
  };

  return packet;
}

/**
 * Normalize state input
 */
function normalizeState(state) {
  if (!state) return 'tn';

  const stateLower = state.toLowerCase().trim();
  const stateMap = {
    'tn': 'tn', 'tennessee': 'tn',
    'pa': 'pa', 'pennsylvania': 'pa', 'penn': 'pa',
    'nj': 'nj', 'new jersey': 'nj', 'newjersey': 'nj',
    'ms': 'ms', 'mississippi': 'ms', 'miss': 'ms'
  };

  return stateMap[stateLower] || 'tn';
}

/**
 * Load JSON file with fallback
 */
function loadJsonFile(filePath, fallback) {
  try {
    if (fs.existsSync(filePath)) {
      const content = fs.readFileSync(filePath, 'utf8');
      return JSON.parse(content);
    }
  } catch (error) {
    console.warn(`Could not load ${filePath}, using defaults`);
  }
  return fallback;
}

/**
 * Get county-specific data
 */
function getCountyData(countyName, state) {
  const paths = getStatePaths(state);
  const countyFile = path.join(paths.counties, `${countyName.toLowerCase()}.json`);
  const defaultCounty = getDefaultCountyData(countyName, state);

  return loadJsonFile(countyFile, defaultCounty);
}

/**
 * Validate and normalize ticket data
 */
function validateTicketData(data) {
  const state = normalizeState(data.state);

  const validated = {
    citationNumber: data.citationNumber || 'UNKNOWN',
    violationType: normalizeViolationType(data.violationType || 'speeding'),
    violationDate: data.violationDate || new Date().toISOString().split('T')[0],
    state: state,
    county: normalizeCounty(data.county || getDefaultCounty(state), state),
    courtType: data.courtType || getDefaultCourtType(state),
    speed: data.speed || null,
    speedLimit: data.speedLimit || null,
    location: data.location || '',
    officerName: data.officerName || '',
    agency: data.agency || '',
    notes: data.notes || '',
    isCommercialLicense: data.isCommercialLicense || false,
    priorViolations: data.priorViolations || 0
  };

  return validated;
}

/**
 * Get default county based on state
 */
function getDefaultCounty(state) {
  const defaultCounties = {
    tn: 'davidson',
    pa: 'philadelphia',
    nj: 'essex',
    ms: 'hinds'
  };
  return defaultCounties[state] || 'davidson';
}

/**
 * Get default court type based on state
 */
function getDefaultCourtType(state) {
  const defaultCourtTypes = {
    tn: 'general_sessions',
    pa: 'magisterial_district',
    nj: 'municipal',
    ms: 'justice'
  };
  return defaultCourtTypes[state] || 'general_sessions';
}

/**
 * Normalize violation type to standard key
 */
function normalizeViolationType(type) {
  const violationMap = {
    'speeding': 'speeding',
    'speed': 'speeding',
    'excessive speed': 'speeding',
    'reckless driving': 'recklessDriving',
    'reckless': 'recklessDriving',
    'careless driving': 'carelessDriving',
    'careless': 'carelessDriving',
    'suspended license': 'suspendedLicense',
    'driving while suspended': 'suspendedLicense',
    'dws': 'suspendedLicense',
    'no insurance': 'noInsurance',
    'failure to maintain financial responsibility': 'noInsurance',
    'no proof of insurance': 'noInsurance',
    'improper lane change': 'improperLaneChange',
    'lane violation': 'improperLaneChange',
    'failure to yield': 'failureToYield',
    'yield': 'failureToYield',
    'following too close': 'followingTooClose',
    'tailgating': 'followingTooClose',
    'failure to signal': 'failureToSignal',
    'no turn signal': 'failureToSignal',
    'red light': 'runningRedLight',
    'ran red light': 'runningRedLight',
    'stop sign': 'stopSign',
    'ran stop sign': 'stopSign',
    'expired registration': 'expiredRegistration',
    'expired tags': 'expiredRegistration',
    'equipment': 'equipmentViolation',
    'equipment violation': 'equipmentViolation',
    'unsafe driving': 'unsafeDriving',
    'unsafe': 'unsafeDriving'
  };

  const normalized = type.toLowerCase().trim();
  return violationMap[normalized] || 'speeding';
}

/**
 * Normalize county name by state
 */
function normalizeCounty(county, state) {
  const countyLower = county.toLowerCase().trim();

  // State-specific county mappings
  const countyMaps = {
    tn: {
      'davidson': 'davidson', 'nashville': 'davidson',
      'shelby': 'shelby', 'memphis': 'shelby',
      'knox': 'knox', 'knoxville': 'knox',
      'hamilton': 'hamilton', 'chattanooga': 'hamilton',
      'rutherford': 'rutherford', 'williamson': 'williamson'
    },
    pa: {
      'philadelphia': 'philadelphia', 'philly': 'philadelphia',
      'allegheny': 'allegheny', 'pittsburgh': 'allegheny',
      'bucks': 'bucks', 'montgomery': 'montgomery',
      'delaware': 'delaware', 'chester': 'chester'
    },
    nj: {
      'bergen': 'bergen', 'essex': 'essex', 'newark': 'essex',
      'hudson': 'hudson', 'jerseycity': 'hudson', 'jersey city': 'hudson',
      'middlesex': 'middlesex', 'monmouth': 'monmouth',
      'ocean': 'ocean', 'union': 'union'
    },
    ms: {
      'hinds': 'hinds', 'jackson': 'hinds',
      'harrison': 'harrison', 'gulfport': 'harrison', 'biloxi': 'harrison',
      'desoto': 'desoto', 'desoto': 'desoto',
      'rankin': 'rankin', 'madison': 'madison'
    }
  };

  const stateMap = countyMaps[state] || countyMaps.tn;
  return stateMap[countyLower] || countyLower.replace(/\s+county$/i, '');
}

/**
 * Analyze the violation for defense options
 */
function analyzeViolation(data, statutes, procedures, state) {
  const violationType = data.violationType;
  const statute = statutes.statutes[violationType] || {};
  const procedure = procedures.proceduresByViolation[violationType] || {};

  const analysis = {
    severity: determineSeverity(violationType, data, state),
    isCriminal: isCriminalViolation(violationType, state),
    defenseOptions: [],
    riskFactors: [],
    mitigatingFactors: [],
    stateSpecificNotes: getStateSpecificAnalysisNotes(state, violationType)
  };

  // Add speed-based analysis for speeding
  if (violationType === 'speeding' && data.speed && data.speedLimit) {
    const overSpeed = data.speed - data.speedLimit;
    analysis.speedOver = overSpeed;
    analysis.speedCategory = categorizeSpeeding(overSpeed, state);

    if (overSpeed <= 10) {
      analysis.mitigatingFactors.push('Minor speed over limit (10 mph or less)');
    }
    if (overSpeed >= 25) {
      analysis.riskFactors.push('Significant speed over limit (25+ mph)');
    }
  }

  // Commercial license considerations
  if (data.isCommercialLicense) {
    analysis.riskFactors.push('CDL holder - stricter penalties may apply');
    analysis.notes = 'Commercial drivers face additional consequences and should consider legal representation.';
  }

  // Prior violations
  if (data.priorViolations > 0) {
    analysis.riskFactors.push(`Prior violations on record (${data.priorViolations})`);
  }

  return analysis;
}

/**
 * Get state-specific analysis notes
 */
function getStateSpecificAnalysisNotes(state, violationType) {
  const notes = {
    nj: {
      speeding: 'New Jersey requires mandatory court appearance for 20+ mph over in 65 zones or 25+ in other zones.',
      recklessDriving: 'Mandatory court appearance required.',
      suspendedLicense: 'Mandatory court appearance. This is a disorderly persons offense.',
      noInsurance: 'Mandatory court appearance. 9 points assessed on conviction.',
      general: 'New Jersey allows plea bargaining with the Unsafe Driving statute (39:4-97.2) which carries no points but a surcharge.'
    },
    pa: {
      speeding: 'Pennsylvania has specific SPMDEE (speed timing device) requirements that can be challenged.',
      recklessDriving: 'Summary offense in PA, not a misdemeanor.',
      general: 'Pennsylvania does NOT offer traffic school as part of plea bargaining - only by court order after conviction.'
    },
    ms: {
      general: 'Mississippi allows traffic school for first-time offenders with minor violations.'
    },
    tn: {
      general: 'Tennessee offers diversion programs for eligible first-time offenders.'
    }
  };

  return notes[state]?.[violationType] || notes[state]?.general || null;
}

/**
 * Determine violation severity
 */
function determineSeverity(violationType, data, state) {
  const severeViolations = ['recklessDriving', 'suspendedLicense'];
  const moderateViolations = ['runningRedLight', 'stopSign', 'failureToYield'];

  if (severeViolations.includes(violationType)) {
    return 'serious';
  }

  if (violationType === 'speeding' && data.speed && data.speedLimit) {
    const overSpeed = data.speed - data.speedLimit;
    if (overSpeed >= 25) return 'serious';
    if (overSpeed >= 15) return 'moderate';
  }

  if (moderateViolations.includes(violationType)) {
    return 'moderate';
  }

  return 'minor';
}

/**
 * Check if violation is criminal by state
 */
function isCriminalViolation(violationType, state) {
  const criminalByState = {
    tn: ['recklessDriving', 'suspendedLicense', 'dui'],
    pa: ['suspendedLicense', 'dui'], // reckless driving is summary offense in PA
    nj: ['suspendedLicense', 'dui'], // reckless driving is motor vehicle violation
    ms: ['recklessDriving', 'suspendedLicense', 'dui']
  };

  return (criminalByState[state] || criminalByState.tn).includes(violationType);
}

/**
 * Categorize speeding by mph over limit (state-specific thresholds)
 */
function categorizeSpeeding(mphOver, state) {
  // NJ has stricter thresholds
  if (state === 'nj') {
    if (mphOver <= 14) return 'minor';
    if (mphOver <= 29) return 'moderate';
    return 'serious';
  }

  // Default
  if (mphOver <= 10) return 'minor';
  if (mphOver <= 20) return 'moderate';
  if (mphOver <= 30) return 'serious';
  return 'severe';
}

/**
 * Get statute information
 */
function getStatuteInfo(violationType, statutes) {
  const statute = statutes.statutes[violationType];
  if (!statute) {
    return {
      code: 'Unknown',
      title: 'Traffic Violation',
      description: 'Contact court for specific statute information'
    };
  }
  return statute;
}

/**
 * Classify violation
 */
function classifyViolation(violationType, statutes) {
  const statute = statutes.statutes[violationType];
  if (!statute) return 'Traffic Infraction';

  if (statute.classification) {
    if (typeof statute.classification === 'object') {
      return statute.classification.first_offense || 'Misdemeanor';
    }
    return statute.classification;
  }

  return 'Traffic Infraction';
}

/**
 * Calculate points for violation (state-specific)
 */
function calculatePoints(violationType, statutes, data, state) {
  const statute = statutes.statutes[violationType];
  if (!statute) return 0;

  if (violationType === 'speeding' && data.speed && data.speedLimit && statute.points) {
    const overSpeed = data.speed - data.speedLimit;

    // State-specific point calculations
    if (state === 'nj') {
      if (overSpeed <= 14) return statute.points['1-14_over'] || 2;
      if (overSpeed <= 29) return statute.points['15-29_over'] || 4;
      return statute.points['30+_over'] || 5;
    }

    if (state === 'pa') {
      if (overSpeed <= 5) return statute.points['1-5_over'] || 2;
      if (overSpeed <= 10) return statute.points['6-10_over'] || 3;
      if (overSpeed <= 15) return statute.points['11-15_over'] || 3;
      if (overSpeed <= 25) return statute.points['16-25_over'] || 4;
      if (overSpeed <= 30) return statute.points['26-30_over'] || 5;
      return statute.points['31+_over'] || 5;
    }

    if (state === 'ms') {
      if (overSpeed <= 5) return statute.points['1-5_over'] || 0;
      if (overSpeed <= 10) return statute.points['6-10_over'] || 2;
      if (overSpeed <= 15) return statute.points['11-15_over'] || 3;
      if (overSpeed <= 20) return statute.points['16-20_over'] || 4;
      if (overSpeed <= 25) return statute.points['21-25_over'] || 5;
      return statute.points['26+_over'] || 6;
    }

    // Tennessee/default
    if (overSpeed <= 15) return statute.points['1-15_over'] || 1;
    if (overSpeed <= 25) return statute.points['16-25_over'] || 3;
    if (overSpeed <= 35) return statute.points['26-35_over'] || 4;
    return statute.points['36+_over'] || 5;
  }

  if (typeof statute.points === 'object' && !statute.points['1-15_over']) {
    return statute.points.general || 3;
  }

  return statute.points || 0;
}

/**
 * Get potential penalties
 */
function getPotentialPenalties(violationType, statutes, state) {
  const statute = statutes.statutes[violationType];
  if (!statute || !statute.penalties) {
    return {
      fine: 'Varies by jurisdiction',
      points: 'May apply'
    };
  }
  return statute.penalties;
}

/**
 * Generate defense strategies
 */
function generateDefenseStrategies(data, statutes, procedures) {
  const violationType = data.violationType;
  const procedure = procedures.proceduresByViolation[violationType] || {};
  const strategies = [];

  if (procedure.defenseStrategies) {
    procedure.defenseStrategies.forEach((strategy, index) => {
      strategies.push({
        id: index + 1,
        name: strategy.name,
        description: strategy.description,
        steps: strategy.steps || [],
        successFactors: strategy.success_factors || [],
        applicableTo: data.location || 'this violation'
      });
    });
  }

  // Add general defense tactics
  if (procedures.generalDefenseTactics) {
    procedures.generalDefenseTactics.forEach((tactic, index) => {
      strategies.push({
        id: strategies.length + index + 1,
        name: tactic.name,
        description: tactic.description,
        steps: tactic.items || [],
        considerations: tactic.considerations || [],
        type: 'general'
      });
    });
  }

  return strategies;
}

/**
 * Get applicable procedures
 */
function getApplicableProcedures(data, procedures, state) {
  const violationType = data.violationType;
  const procedure = procedures.proceduresByViolation[violationType] || {};

  return {
    immediateActions: procedure.immediateActions || [],
    possibleOutcomes: procedure.possibleOutcomes || [],
    timeline: procedure.timeline || {},
    trafficSchool: procedures.trafficSchoolOptions || null,
    diversion: procedures.generalProcedures?.diversionEligibility || null,
    mandatoryCourtAppearance: procedure.mandatoryCourtAppearance || procedure.mandatoryCourt || false
  };
}

/**
 * Determine appropriate court based on state
 */
function determineCourt(data, countyData, state) {
  const courtTypes = {
    tn: 'generalSessions',
    pa: 'magisterialDistrict',
    nj: 'municipal',
    ms: 'justice'
  };

  const courtType = courtTypes[state] || 'generalSessions';

  if (data.courtType === 'municipal' && countyData.courts?.municipal) {
    return countyData.courts.municipal;
  }

  return countyData.courts?.[courtType] || countyData.courts?.generalSessions || {};
}

/**
 * Generate timeline for case
 */
function generateTimeline(data, countyData, state) {
  const today = new Date();
  const violationDate = new Date(data.violationDate);

  const timeline = {
    violationDate: violationDate.toISOString().split('T')[0],
    actions: []
  };

  // State-specific deadlines
  const deadlines = {
    tn: { contest: 7, courtEstimate: 35, trafficSchool: 90 },
    pa: { contest: 10, courtEstimate: 30, trafficSchool: 60 },
    nj: { contest: 0, courtEstimate: 21, trafficSchool: 90 }, // NJ uses court date on ticket
    ms: { contest: 7, courtEstimate: 30, trafficSchool: 90 }
  };

  const stateDeadlines = deadlines[state] || deadlines.tn;

  // Contest deadline
  if (stateDeadlines.contest > 0) {
    const contestDeadline = new Date(violationDate);
    contestDeadline.setDate(contestDeadline.getDate() + stateDeadlines.contest);
    timeline.actions.push({
      date: contestDeadline.toISOString().split('T')[0],
      action: 'Contest deadline',
      description: `Last day to appear or pay ticket in ${STATE_INFO[state].name}`,
      urgent: true
    });
  } else {
    timeline.actions.push({
      date: 'See ticket',
      action: 'Court appearance',
      description: 'Court date is listed on your summons - check ticket',
      urgent: true
    });
  }

  // Court date estimate
  const courtDateEstimate = new Date(today);
  courtDateEstimate.setDate(courtDateEstimate.getDate() + stateDeadlines.courtEstimate);
  timeline.actions.push({
    date: 'TBD',
    action: 'Court date (if contesting)',
    description: `Typically ${stateDeadlines.courtEstimate} days from arraignment; estimated: ${courtDateEstimate.toISOString().split('T')[0]}`,
    urgent: false
  });

  // Traffic school deadline
  const trafficSchoolDeadline = new Date(today);
  trafficSchoolDeadline.setDate(trafficSchoolDeadline.getDate() + stateDeadlines.trafficSchool);
  timeline.actions.push({
    date: trafficSchoolDeadline.toISOString().split('T')[0],
    action: 'Traffic school deadline (if ordered)',
    description: `Must complete within ${stateDeadlines.trafficSchool} days if ordered by court`,
    urgent: false
  });

  return timeline;
}

/**
 * Generate document checklist
 */
function generateDocumentChecklist(data, state) {
  const checklist = [
    {
      item: 'Traffic citation/copy of ticket',
      required: true,
      notes: 'Keep original; bring copy to court'
    },
    {
      item: 'Valid driver license',
      required: true,
      notes: 'Check expiration date'
    },
    {
      item: 'Proof of insurance',
      required: true,
      notes: getInsuranceRequirements(state)
    },
    {
      item: 'Vehicle registration',
      required: true,
      notes: 'Current registration required'
    }
  ];

  // Add violation-specific documents
  if (data.violationType === 'speeding') {
    checklist.push({
      item: 'Photos of speed limit signs',
      required: false,
      notes: 'Document visibility and placement'
    });
    checklist.push({
      item: 'Speedometer calibration certificate',
      required: false,
      notes: 'If you believe speedometer was inaccurate'
    });
  }

  if (data.violationType === 'equipmentViolation') {
    checklist.push({
      item: 'Repair receipt/documentation',
      required: true,
      notes: 'Proof of prompt repair may result in dismissal'
    });
  }

  if (data.violationType === 'noInsurance') {
    checklist.push({
      item: 'Insurance card/policy documentation',
      required: true,
      notes: 'Proof of coverage at time of stop may result in dismissal'
    });
  }

  checklist.push({
    item: 'Witness contact information',
    required: false,
    notes: 'Any witnesses to the violation'
  });

  checklist.push({
    item: 'Dash cam footage (if available)',
    required: false,
    notes: 'Preserve any video evidence'
  });

  return checklist;
}

/**
 * Get insurance requirements by state
 */
function getInsuranceRequirements(state) {
  const requirements = {
    tn: 'Must meet Tennessee minimums ($25K/$50K/$15K)',
    pa: 'Must meet Pennsylvania minimums ($15K/$30K/$5K)',
    nj: 'Must meet New Jersey minimums ($15K/$30K/$5K + PIP)',
    ms: 'Must meet Mississippi minimums ($25K/$50K/$25K)'
  };
  return requirements[state] || requirements.tn;
}

/**
 * Generate resources
 */
function generateResources(data, countyData, state) {
  const resources = {
    courts: [],
    legalAid: [],
    trafficSchool: [],
    barAssociation: null
  };

  // Add court information
  if (countyData.courts) {
    Object.values(countyData.courts).forEach(court => {
      if (court.name) {
        resources.courts.push({
          name: court.name,
          address: court.address,
          phone: court.phone,
          hours: court.hours,
          website: court.website
        });
      }
    });
  }

  // Add legal aid
  if (countyData.additionalResources?.legalAid) {
    resources.legalAid.push(countyData.additionalResources.legalAid);
  }

  // Add bar association
  if (countyData.additionalResources?.lawyerReferral) {
    resources.barAssociation = countyData.additionalResources.lawyerReferral;
  }

  // Add statewide resources
  resources.statewide = {
    barAssociation: {
      name: STATE_INFO[state].barAssociation,
      phone: STATE_INFO[state].barPhone,
      website: STATE_INFO[state].barWebsite
    }
  };

  // Add state-specific resources
  if (state === 'tn') {
    resources.statewide.departmentOfSafety = {
      name: 'Tennessee Department of Safety',
      phone: '(615) 741-3954',
      website: 'www.tn.gov/safety'
    };
  } else if (state === 'pa') {
    resources.statewide.penndot = {
      name: 'Pennsylvania Department of Transportation (PennDOT)',
      phone: '(717) 412-5300',
      website: 'www.penndot.gov'
    };
  } else if (state === 'nj') {
    resources.statewide.njmvc = {
      name: 'New Jersey Motor Vehicle Commission (NJMVC)',
      phone: '(609) 292-6500',
      website: 'www.nj.gov/mvc'
    };
  } else if (state === 'ms') {
    resources.statewide.dps = {
      name: 'Mississippi Department of Public Safety',
      phone: '(601) 987-1212',
      website: 'www.dps.ms.gov'
    };
  }

  return resources;
}

/**
 * Get state-specific information
 */
function getStateSpecificInfo(state, data) {
  const info = {
    tn: {
      pointSystem: {
        description: 'Tennessee Point System',
        suspensionThreshold: 12,
        pointDuration: '2 years',
        warningLevel: '8-11 points'
      },
      diversionAvailable: true,
      trafficSchoolNote: 'Available through court or diversion'
    },
    pa: {
      pointSystem: {
        description: 'Pennsylvania Point System',
        suspensionThreshold: 11,
        pointDuration: 'Points removed at 3 per year for safe driving',
        warningLevel: '6 points triggers special examination'
      },
      spmddeNote: 'PA has specific speed timing device requirements',
      trafficSchoolNote: 'NOT available on plea bargaining - only by court order after conviction'
    },
    nj: {
      pointSystem: {
        description: 'New Jersey Point System',
        suspensionThreshold: 12,
        insuranceSurcharges: '$150-300/year for 6+ points',
        pointReduction: '2 points for defensive driving course'
      },
      unsafeDrivingStatute: {
        code: 'N.J.S.A. 39:4-97.2',
        description: 'No-points plea option',
        limitations: 'Only twice per 5 years',
        surcharge: '$250 first, $400 second'
      },
      mandatoryCourtAppearances: [
        'Reckless driving',
        'Driving while suspended',
        'No insurance',
        'Speeding 20+ over in 65 zones'
      ]
    },
    ms: {
      pointSystem: {
        description: 'Mississippi Point System',
        suspensionThreshold: 12,
        pointDuration: '2-3 years',
        warningLevel: '8-11 points'
      },
      trafficSchoolNote: 'May be available for first-time minor offenses'
    }
  };

  return info[state] || info.tn;
}

/**
 * Generate printable sections for PDF output
 */
function generatePrintableSections(data, statutes, procedures, countyData, state) {
  const stateInfo = STATE_INFO[state];
  const disclaimers = getDisclaimers(state);

  return {
    coverPage: {
      title: `${stateInfo.name.toUpperCase()} TRAFFIC TICKET DEFENSE PACKET`,
      subtitle: 'Informational Guide for Self-Representation',
      citationNumber: data.citationNumber,
      state: stateInfo.name,
      county: data.county.charAt(0).toUpperCase() + data.county.slice(1) + ' County',
      violationType: data.violationType.replace(/([A-Z])/g, ' $1').trim(),
      disclaimer: disclaimers.header
    },
    summaryPage: generateSummaryPage(data, statutes, countyData, state),
    defenseStrategiesPage: generateDefensePage(data, procedures, state),
    proceduresPage: generateProceduresPage(data, procedures, countyData, state),
    checklistPage: generateChecklistPage(data, state),
    courtInfoPage: generateCourtInfoPage(countyData, state),
    stateSpecificPage: generateStateSpecificPage(state, data)
  };
}

/**
 * Generate summary page content
 */
function generateSummaryPage(data, statutes, countyData, state) {
  const stateInfo = STATE_INFO[state];
  const points = calculatePoints(data.violationType, statutes, data, state);

  return {
    title: 'Citation Summary',
    sections: [
      {
        heading: 'Citation Information',
        content: [
          `Citation Number: ${data.citationNumber}`,
          `State: ${stateInfo.name}`,
          `Violation Type: ${data.violationType.replace(/([A-Z])/g, ' $1').trim()}`,
          `Violation Date: ${data.violationDate}`,
          `Location: ${data.location || 'Not specified'}`,
          `Issuing Agency: ${data.agency || 'Not specified'}`
        ]
      },
      {
        heading: 'Statute Information',
        content: [
          `Statute: ${getStatuteInfo(data.violationType, statutes).code}`,
          `Description: ${getStatuteInfo(data.violationType, statutes).description || 'Traffic violation'}`,
          `Classification: ${classifyViolation(data.violationType, statutes)}`,
          `Potential Points: ${points}`
        ]
      },
      {
        heading: 'Court Information',
        content: [
          `County: ${countyData.name || data.county}`,
          `Court: ${countyData.courts?.municipal?.name || countyData.courts?.generalSessions?.name || 'Contact court'}`,
          `Address: ${countyData.courts?.municipal?.address || countyData.courts?.generalSessions?.address || 'Contact court'}`,
          `Phone: ${countyData.courts?.municipal?.phone || countyData.courts?.generalSessions?.phone || 'Contact court'}`
        ]
      }
    ]
  };
}

/**
 * Generate defense strategies page content
 */
function generateDefensePage(data, procedures, state) {
  const procedure = procedures.proceduresByViolation[data.violationType] || {};
  const strategies = procedure.defenseStrategies || [];

  const sections = [
    {
      heading: 'Immediate Actions',
      content: procedure.immediateActions || []
    }
  ];

  strategies.forEach((strategy, index) => {
    sections.push({
      heading: `Defense Strategy ${index + 1}: ${strategy.name}`,
      content: [strategy.description],
      steps: strategy.steps || []
    });
  });

  // Add state-specific defense note
  if (state === 'nj') {
    sections.push({
      heading: 'New Jersey-Specific Option: Unsafe Driving Plea',
      content: ['New Jersey allows pleading to N.J.S.A. 39:4-97.2 (Unsafe Driving) which carries no points but includes a surcharge.'],
      steps: [
        'Request plea conference with prosecutor',
        'Ask for downgrade to unsafe driving',
        'Pay surcharge ($250-$400) instead of points',
        'Limited to 2 uses per 5 years'
      ]
    });
  }

  return {
    title: 'Defense Strategies',
    sections: sections,
    note: 'These strategies are informational. Effectiveness depends on specific circumstances.'
  };
}

/**
 * Generate procedures page content
 */
function generateProceduresPage(data, procedures, countyData, state) {
  return {
    title: 'Court Procedures',
    sections: [
      {
        heading: 'How to Contest Your Ticket',
        content: countyData.procedures?.contestingTicket?.process || [
          'Contact the court to enter your plea',
          'Request a court date',
          'File discovery request if needed',
          'Appear on scheduled court date'
        ]
      },
      {
        heading: 'Important Deadlines',
        content: getStateDeadlines(state, countyData)
      },
      {
        heading: 'State-Specific Notes',
        content: getStateSpecificProcedures(state)
      }
    ]
  };
}

/**
 * Get state deadlines
 */
function getStateDeadlines(state, countyData) {
  const deadlines = {
    tn: [
      'Contest deadline: 7 days from citation',
      'Court date: Will be assigned when you enter not guilty plea',
      'Traffic school (if ordered): Typically 90 days'
    ],
    pa: [
      'Contest deadline: Within 10 days of citation',
      'Appeal deadline: 30 days from summary conviction',
      'Traffic school: Only by court order after conviction'
    ],
    nj: [
      'Court appearance: Check ticket for scheduled date',
      'Appeal deadline: 20 days from conviction',
      'Traffic school: 2 points reduced for approved course'
    ],
    ms: [
      'Contest deadline: 7 days or by court date on citation',
      'Appeal deadline: 30 days from conviction',
      'Traffic school: May be offered for minor first offenses'
    ]
  };

  return deadlines[state] || deadlines.tn;
}

/**
 * Get state-specific procedures
 */
function getStateSpecificProcedures(state) {
  const procedures = {
    tn: [
      'General Sessions Court handles most traffic matters',
      'May appeal to Circuit Court for de novo trial'
    ],
    pa: [
      'Magisterial District Courts handle traffic summary offenses',
      '30-day right to appeal to Court of Common Pleas',
      'No traffic school available for plea bargaining'
    ],
    nj: [
      'Municipal Courts handle traffic matters',
      'Plea conferences available with prosecutor',
      'Unsafe Driving statute (39:4-97.2) available for no-points plea'
    ],
    ms: [
      'Justice Courts handle county traffic matters',
      'Municipal Courts handle city violations',
      'Traffic school may be offered for minor offenses'
    ]
  };

  return procedures[state] || procedures.tn;
}

/**
 * Generate checklist page content
 */
function generateChecklistPage(data, state) {
  const checklist = generateDocumentChecklist(data, state);

  return {
    title: 'Document Checklist',
    items: checklist.map(item => ({
      checked: false,
      item: item.item,
      required: item.required,
      notes: item.notes
    }))
  };
}

/**
 * Generate court info page content
 */
function generateCourtInfoPage(countyData, state) {
  return {
    title: 'Court Information',
    state: STATE_INFO[state].name,
    courts: countyData.courts || {},
    localRules: countyData.localRules || {},
    parking: countyData.parkingAndTransit || {},
    additionalResources: countyData.additionalResources || {}
  };
}

/**
 * Generate state-specific page
 */
function generateStateSpecificPage(state, data) {
  const stateInfo = getStateSpecificInfo(state, data);

  return {
    title: `${STATE_INFO[state].name}-Specific Information`,
    content: stateInfo
  };
}

// Default data functions for fallback

function getDefaultStatutes(state) {
  const defaults = {
    tn: {
      title: 'Tennessee Traffic Code Statutes',
      statutes: {
        speeding: { code: 'TCA 55-8-152', title: 'Speed limitations', points: { '1-15_over': 1, '16-25_over': 3, '26-35_over': 4, '36+_over': 5 } },
        recklessDriving: { code: 'TCA 55-10-205', classification: 'Class B Misdemeanor', points: 6 }
      }
    },
    pa: {
      title: 'Pennsylvania Vehicle Code',
      statutes: {
        speeding: { code: '75 Pa.C.S. 3362', title: 'Maximum speed limits', points: { '1-5_over': 2, '6-10_over': 3, '16-25_over': 4, '26+_over': 5 } },
        recklessDriving: { code: '75 Pa.C.S. 3736', classification: 'Summary Offense', points: 3 }
      }
    },
    nj: {
      title: 'New Jersey Motor Vehicle Statutes',
      statutes: {
        speeding: { code: 'N.J.S.A. 39:4-98', title: 'Speed regulations', points: { '1-14_over': 2, '15-29_over': 4, '30+_over': 5 } },
        recklessDriving: { code: 'N.J.S.A. 39:4-96', points: 5 }
      }
    },
    ms: {
      title: 'Mississippi Motor Vehicle Code',
      statutes: {
        speeding: { code: 'MS Code 63-3-501', title: 'Speed limits', points: { '6-10_over': 2, '11-15_over': 3, '16-20_over': 4, '21-25_over': 5, '26+_over': 6 } },
        recklessDriving: { code: 'MS Code 63-3-1201', classification: 'Misdemeanor', points: 6 }
      }
    }
  };

  return defaults[state] || defaults.tn;
}

function getDefaultProcedures(state) {
  return {
    proceduresByViolation: {
      speeding: {
        immediateActions: ['Review ticket for accuracy', 'Document conditions'],
        defenseStrategies: [
          {
            name: 'Calibration Challenge',
            description: 'Challenge accuracy of speed measurement',
            steps: ['Request calibration records', 'Verify device certification']
          }
        ]
      }
    },
    generalDefenseTactics: [
      {
        name: 'Discovery Request',
        items: ["Officer's notes", 'Calibration records', 'Training certifications']
      }
    ]
  };
}

function getDefaultCountyData(countyName, state) {
  const stateName = STATE_INFO[state]?.name || 'Tennessee';
  return {
    name: countyName.charAt(0).toUpperCase() + countyName.slice(1) + ' County',
    state: stateName,
    courts: {
      generalSessions: {
        name: `${countyName.charAt(0).toUpperCase() + countyName.slice(1)} County Court`,
        address: 'Contact court for address',
        phone: 'Contact court for phone number'
      }
    },
    procedures: {
      contestingTicket: {
        deadline: '7-10 days from citation date',
        process: ['Contact court', 'Enter plea', 'Request court date']
      }
    }
  };
}

module.exports = {
  generateTrafficTicketPacket,
  validateTicketData,
  normalizeViolationType,
  normalizeCounty,
  normalizeState,
  analyzeViolation,
  generateDefenseStrategies,
  calculatePoints,
  getCountyData,
  getDisclaimers,
  STATE_INFO
};
